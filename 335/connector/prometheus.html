
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>6.24. Prometheus Connector &#8212; Presto 335 Documentation</title>
    <link rel="stylesheet" href="../_static/presto.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '335',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.25. Redis Connector" href="redis.html" />
    <link rel="prev" title="6.23. PostgreSQL Connector" href="postgresql.html" /> 
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133457846-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-133457846-1');
    </script>
  </head>
  <body>
<div class="header">
    <h1 class="heading"><a href="../index.html">
        <span>Presto 335 Documentation</span></a></h1>
    <h2 class="heading"><span>6.24. Prometheus Connector</span></h2>
</div>
<div class="topnav">
    
<p class="nav">
    <span class="left">
        &laquo; <a href="postgresql.html">6.23. PostgreSQL Connector</a>
    </span>
    <span class="right">
        <a href="redis.html">6.25. Redis Connector</a> &raquo;
    </span>
</p>

</div>
<div class="content">
    
  <div class="section" id="prometheus-connector">
<h1>6.24. Prometheus Connector<a class="headerlink" href="#prometheus-connector" title="Permalink to this headline">#</a></h1>
<p>The Prometheus connector allows reading
<a class="reference external" href="https://prometheus.io/">Prometheus</a>.
metrics as tables in Presto.</p>
<p>The mechanism for querying Prometheus is to use the Prometheus HTTP API. Specifically, all queries are resolved to Prometheus Instant queries
with a form like: <a class="reference external" href="http://localhost:9090/api/v1/query?query=up[21d]&amp;time=1568229904.000">http://localhost:9090/api/v1/query?query=up[21d]&amp;time=1568229904.000</a>‚Äù
In this case the <code class="docutils literal"><span class="pre">up</span></code> metric is taken from the Presto query table name. <code class="docutils literal"><span class="pre">21d</span></code> is the duration of the query. The Prometheus <code class="docutils literal"><span class="pre">time</span></code> value
corresponds to the <code class="docutils literal"><span class="pre">timestamp</span></code> field. Presto queries are translated from their use of the <code class="docutils literal"><span class="pre">timestamp</span></code> field to a duration and time value
as needed. Presto splits are generated by dividing the query range into attempted equal chunks.</p>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">#</a></h2>
<p>Create <code class="docutils literal"><span class="pre">etc/catalog/prometheus.properties</span></code>
to mount the Prometheus connector as the <code class="docutils literal"><span class="pre">prometheus</span></code> catalog,
replacing the properties as appropriate:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>connector.name=prometheus
prometheus.uri=http://localhost:9090
prometheus.query.chunk.size.duration=1d
prometheus.max.query.range.duration=21d
prometheus.cache.ttl=30s
prometheus.bearer.token.file=/path/to/bearer/token/file
</pre></div>
</div>
</div>
<div class="section" id="configuration-properties">
<h2>Configuration Properties<a class="headerlink" href="#configuration-properties" title="Permalink to this headline">#</a></h2>
<p>The following configuration properties are available:</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">prometheus.uri</span></code></td>
<td>Where to find Prometheus coordinator host</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">prometheus.query.chunk.size.duration</span></code></td>
<td>The duration of each query to Prometheus</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">prometheus.max.query.range.duration</span></code></td>
<td>Width of overall query to Prometheus, will be divided into query-chunk-size-duration queries</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">prometheus.cache.ttl</span></code></td>
<td>How long values from this config file are cached</td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">prometheus.bearer.token.file</span></code></td>
<td>File holding bearer token if needed for access to Prometheus</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="not-exhausting-your-presto-available-heap">
<h2>Not Exhausting Your Presto Available Heap<a class="headerlink" href="#not-exhausting-your-presto-available-heap" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal"><span class="pre">prometheus.query.chunk.size.duration</span></code> and <code class="docutils literal"><span class="pre">prometheus.max.query.range.duration</span></code> are values to protect Presto from
too much data coming back from Prometheus. The <code class="docutils literal"><span class="pre">prometheus.max.query.range.duration</span></code> is the item of
particular interest.</p>
<p>On a Prometheus instance that has been running for awhile and depending
on data retention settings, <code class="docutils literal"><span class="pre">21d</span></code> might be far too much. Perhaps <code class="docutils literal"><span class="pre">1h</span></code> might be a more reasonable setting.
In the case of <code class="docutils literal"><span class="pre">1h</span></code> it might be then useful to set <code class="docutils literal"><span class="pre">prometheus.query.chunk.size.duration</span></code> to <code class="docutils literal"><span class="pre">10m</span></code>, dividing the
query window into 6 queries each of which can be handled in a Presto split.</p>
<p>Primarily query issuers can limit the amount of data returned by Prometheus by taking
advantage of <code class="docutils literal"><span class="pre">WHERE</span></code> clause limits on <code class="docutils literal"><span class="pre">timestamp</span></code>, setting an upper bound and lower bound that define
a relatively small window. For instance:</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">prometheus</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">up</span> <span class="k">WHERE</span> <span class="k">timestamp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">NOW</span><span class="p">()</span> <span class="o">-</span> <span class="nb">INTERVAL</span> <span class="s1">&#39;10&#39;</span> <span class="k">second</span><span class="p">);</span>
</pre></div>
</div>
<p>If the query does not include a WHERE clause limit, these config
settings are meant to protect against an unlimited query.</p>
</div>
<div class="section" id="bearer-token-authentication">
<h2>Bearer Token Authentication<a class="headerlink" href="#bearer-token-authentication" title="Permalink to this headline">#</a></h2>
<p>Prometheus can be setup to require a Authorization header with every query. The value in
<code class="docutils literal"><span class="pre">prometheus.bearer.token.file</span></code> allows for a bearer token to be read from the configured file. This file
is optional and not required unless your Prometheus setup requires it.</p>
</div>
</div>


</div>
<div class="bottomnav">
    
<p class="nav">
    <span class="left">
        &laquo; <a href="postgresql.html">6.23. PostgreSQL Connector</a>
    </span>
    <span class="right">
        <a href="redis.html">6.25. Redis Connector</a> &raquo;
    </span>
</p>

</div>

    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>